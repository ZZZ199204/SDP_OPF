%%fix the tap issue?????????????????????
%%%fix the capacitance at 9 (19)
%%%% mpc.gen(3) not important...

clear
clc


%% bus data
%	bus_i	type	Pd	Qd	Gs	Bs	area	Vm	Va	baseKV	zone	Vmax	Vmin
mpc_bus = [
	1	3	0	0	0	0	1	1.06	0	0	1	1.06	0.94;
	2	2	21.7	12.7	0	0	1	1.045	-4.98	0	1	1.06	0.94;
	3	2	94.2	19	0	0	1	1.01	-12.72	0	1	1.06	0.94;
	4	1	47.8	-3.9	0	0	1	1.019	-10.33	0	1	1.06	0.94;
	5	1	7.6	1.6	0	0	1	1.02	-8.78	0	1	1.06	0.94;
	6	2	11.2	7.5	0	0	1	1.07	-14.22	0	1	1.06	0.94;
	7	1	0	0	0	0	1	1.062	-13.37	0	1	1.06	0.94;
	8	2	0	0	0	0	1	1.09	-13.36	0	1	1.06	0.94;
	9	1	29.5	16.6	0	19	1	1.056	-14.94	0	1	1.06	0.94;
	10	1	9	5.8	0	0	1	1.051	-15.1	0	1	1.06	0.94;
	11	1	3.5	1.8	0	0	1	1.057	-14.79	0	1	1.06	0.94;
	12	1	6.1	1.6	0	0	1	1.055	-15.07	0	1	1.06	0.94;
	13	1	13.5	5.8	0	0	1	1.05	-15.16	0	1	1.06	0.94;
	14	1	14.9	5	0	0	1	1.036	-16.04	0	1	1.06	0.94;
];

%% generator data
%	bus	Pg	Qg	Qmax	Qmin	Vg	mBase	status	Pmax	Pmin	Pc1	Pc2	Qc1min	Qc1max	Qc2min	Qc2max	ramp_agc	ramp_10	ramp_30	ramp_q	apf
mpc_gen = [
	1	232.4	-16.9	10	0	1.06	100	1	332.4	0	0	0	0	0	0	0	0	0	0	0	0;
	2	40	42.4	50	-40	1.045	100	1	140	0	0	0	0	0	0	0	0	0	0	0	0;
	3	0	23.4	40	0	1.01	100	1	100	0	0	0	0	0	0	0	0	0	0	0	0;
	6	0	12.2	24	-6	1.07	100	1	100	0	0	0	0	0	0	0	0	0	0	0	0;
	8	0	17.4	24	-6	1.09	100	1	100	0	0	0	0	0	0	0	0	0	0	0	0;
];

%% branch data
%	fbus	tbus	r	x	b	rateA	rateB	rateC	ratio	angle	status	angmin	angmax
mpc_branch = [
	1	2	0.01938	0.05917	0.0528	9900	0	0	0	0	1	-360	360;
	1	5	0.05403	0.22304	0.0492	9900	0	0	0	0	1	-360	360;
	2	3	0.04699	0.19797	0.0438	9900	0	0	0	0	1	-360	360;
	2	4	0.05811	0.17632	0.034	9900	0	0	0	0	1	-360	360;
	2	5	0.05695	0.17388	0.0346	9900	0	0	0	0	1	-360	360;
	3	4	0.06701	0.17103	0.0128	9900	0	0	0	0	1	-360	360;
	4	5	0.01335	0.04211	0	9900	0	0	0	0	1	-360	360;
	4	7	0	0.20912	0	9900	0	0	0.978	0	1	-360	360;
	4	9	0	0.55618	0	9900	0	0	0.969	0	1	-360	360;
	5	6	0	0.25202	0	9900	0	0	0.932	0	1	-360	360;
	6	11	0.09498	0.1989	0	9900	0	0	0	0	1	-360	360;
	6	12	0.12291	0.25581	0	9900	0	0	0	0	1	-360	360;
	6	13	0.06615	0.13027	0	9900	0	0	0	0	1	-360	360;
	7	8	0	0.17615	0	9900	0	0	0	0	1	-360	360;
	7	9	0	0.11001	0	9900	0	0	0	0	1	-360	360;
	9	10	0.03181	0.0845	0	9900	0	0	0	0	1	-360	360;
	9	14	0.12711	0.27038	0	9900	0	0	0	0	1	-360	360;
	10	11	0.08205	0.19207	0	9900	0	0	0	0	1	-360	360;
	12	13	0.22092	0.19988	0	9900	0	0	0	0	1	-360	360;
	13	14	0.17093	0.34802	0	9900	0	0	0	0	1	-360	360;
];

%%-----  OPF Data  -----%%
%% generator cost data
%	1	startup	shutdown	n	x1	y1	...	xn	yn
%	2	startup	shutdown	n	c(n-1)	...	c0
mpc_gencost = [
	2	0	0	3	0.0430293	20	0;
	2	0	0	3	0.25	20	0;
	2	0	0	3	0.01	40	0;
	2	0	0	3	0.01	40	0;
	2	0	0	3	0.01	40	0;
];


% mpc_gencost = [
% 	2	0	0	3	0	1	0;
% 	2	0	0	3	0	1	0;
% 	2	0	0	3	0	1	0;
% 	2	0	0	3	0	1	0;
% 	2	0	0	3	0	1	0;
% ];


n=14;

Y=zeros(n,n);
for k=1:size(mpc_branch,1),
    Y(mpc_branch(k,1),mpc_branch(k,2))=-1/(mpc_branch(k,3)+mpc_branch(k,4)*i);
    Y(mpc_branch(k,2),mpc_branch(k,1))=-1/(mpc_branch(k,3)+mpc_branch(k,4)*i);
    C(mpc_branch(k,1),mpc_branch(k,2))=mpc_branch(k,5)*i/2;
    C(mpc_branch(k,2),mpc_branch(k,1))=mpc_branch(k,5)*i/2;
end

for k=1:n,
    Y(k,k)=-sum(Y(k,:))+sum(C(k,:));
end

YY=cell(n,1);
Y_aux=cell(n,1);
Y_real=cell(n,1);
Y_imag=cell(n,1);
M=cell(n,1);

for k=1:size(mpc_branch,1),
    if mpc_branch(k,9)~=0,
        x2=mpc_branch(k,1);
        x1=mpc_branch(k,2);
        a_aux=mpc_branch(k,9);
        Y(x1,x2)=Y(x1,x2)+1/(mpc_branch(k,4)*i)-1/(mpc_branch(k,4)*i)/a_aux;
        Y(x2,x2)=Y(x2,x2)-1/(mpc_branch(k,4)*i)+1/(mpc_branch(k,4)*i)/a_aux^2;
        Y(x2,x1)=Y(x2,x1)+1/(mpc_branch(k,4)*i)-1/(mpc_branch(k,4)*i)/a_aux;
    end
end

%disp(Y);
Y_B=[6.03-19.45i -5+15.26i 0 0 -1.03+4.23i 0 0 0 0 0 0 0 0 0;
    -5+15.26i 9.52-30.27i -1.14+4.78i -1.69+5.12i -1.7+5.19i 0 0 0 0 0 0 0 0 0;
    0 -1.14+4.78i 3.12-9.82i -1.99+5.07i 0 0 0 0 0 0 0 0 0 0;
    0 -1.69+5.12i -1.99+5.07i 10.51-38.65i -6.84+21.58i 0 0+4.89i 0 0+1.86i 0 0 0 0 0;
    -1.03+4.23i -1.7+5.19i 0 -6.84+21.58i 9.57-35.53i 0+4.26i 0 0 0 0 0 0 0 0;
    0 0 0 0 0+4.26i 6.58-17.34i 0 0 0 0 -1.96+4.09i -1.53+3.18i -3.1+6.10i 0;
    0 0 0 0+4.89i 0 0 0-19.55i 0+5.68i 0+9.09i 0 0 0 0 0;
    0 0 0 0 0 0 0+5.68i 0-5.68i 0 0 0 0 0 0;
    0 0 0 0+1.86i 0 0 0+9.09i 0 5.33-24.09i -3.9+10.37i 0 0 0 -1.42+3.03i;
    0 0 0 0 0 0 0 0 -3.9+10.37i 5.78-14.77i -1.88+4.4i 0 0 0;
    0 0 0 0 0 -1.96+4.09i 0 0 0 -1.88+4.4i 3.84-8.5i 0 0 0;
    0 0 0 0 0 -1.53+3.18i 0 0 0 0 0 4.01-5.43i -2.49+2.25i 0;
    0 0 0 0 0 -3.1+6.10i 0 0 0 0 0 -2.49+2.25i 6.72-10.67i -1.14+2.31i;
    0 0 0 0 0 0 0 0 -1.42+3.03i 0 0 0 -1.14+2.31i 2.56-5.34i];
A=Y_B-Y;
disp(A);